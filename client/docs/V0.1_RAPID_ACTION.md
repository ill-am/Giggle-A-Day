# V0.1 RAPID ACTION: UI Responsiveness — Urgent Focus

## Objective

Make the prototype UI feel alive and responsive immediately. Prioritize the smallest set of changes that remove the "dead" feeling from the GUI and provide clear, immediate feedback for every user action. Work in hours, not days.

---

## Top-level decision (scope)

Only changes required to make the GUI responsive for the prototype will be implemented now. Defer deep architectural refactors, extensive instrumentation, and production hardening to follow-up work.

Scope note: to keep the prototype minimal and fast-to-verify, the demo eBook will be restricted to a single page (one poem + decorative background). This reduces export complexity during early UI validation.

Schedule caveat: the team is behind schedule and focused on delivering V0.1 quickly — prefer the simplest, lowest-risk implementations that produce verifiable artifacts for demo and testing.

---

## Priority actionables (execute in order)

Immediate (do now — highest impact, low risk)

0. Dialog + staged flow for primary actions (Generate + Preview + Publish/Export) — 1A → 1B → 1C → 1D → 1E → 1F

- Summary: Roll out the Generate flow in several small, verifiable stages so we validate wiring and avoid unnecessary model calls. Each stage must be tested/verified before enabling the next.

- 1A — typed-prompt dialog (no model call):

  - What: When users click `Generate`, show a small modal/dialog that displays the exact text from the Prompt textarea labeled "this is the typed prompt, not generated output" with a single [OK] to dismiss. Do NOT call the model in this stage.
  - Files: `client/src/components/PromptInput.svelte` (intercept `Generate` click) and an inline dialog or tiny `Dialog.svelte` component.
  - Acceptance: clicking Generate with a non-empty prompt opens the typed-prompt dialog; OK dismisses and returns focus; no network requests are made.
  - Est.: 0.25–0.5h

- 1B — modal shows generated text (single model call):

  - What: After 1A verification, enable the modal to display the model-generated text for the given prompt. The UI must call the generation service exactly ONCE for this user intent. Show the returned text in the modal alongside an OK button. Do NOT trigger additional model calls on confirm.
  - Files: `PromptInput.svelte`, `Dialog.svelte`, and the request/caching layer (e.g., `previewStore` or `generationCache.js`).
  - Acceptance: clicking Generate triggers exactly one model call; modal displays the returned generated text; OK dismisses and caches the generated text for reuse.
  - Est.: 0.5–1.5h

- 1C — paste/post generated text into Preview (reuse cached result):

  - What: After 1B is validated, change the modal confirm so OK pastes (or posts) the cached generated text into the Preview area. No additional model calls must be made — use the cached result from 1B.
  - Files: `PreviewWindow.svelte` (or `Preview.svelte`), `previewStore` for consuming cached generated text.
  - Acceptance: confirming the modal places the generated content into the Preview area; no extra model calls occur; UI remains responsive.
  - Est.: 0.25–0.75h

- 1D — allow editing the generated text (local overrides, no extra model calls):

  - What: After 1C is validated, allow the user to edit the generated text directly in the Preview. Edits must be stored as `userOverrides` in the `previewStore` keyed by the `updateId` so the original generated result is preserved for revert/compare. No model calls should be triggered by simple edits.
  - Files: `client/src/components/PreviewWindow.svelte` (add Edit/Save/Cancel UI), `client/src/stores/previewStore.js` (add `userOverrides` API), optional `PreviewEditor.svelte` for an isolated editor UI.
  - Acceptance: user can enter edit mode, modify text, Save updates the preview and stores the override under the originating `updateId`; Revert restores original generated text; no model calls occur during edit/save unless the user explicitly requests regeneration.
  - Est.: 0.5–1.5h

- 1E — Image / background override (regenerate + accept):

  - Goal: let the user replace or regenerate the decorative background image for the one-page eBook (one poem) with a small, low-friction flow that follows the same single-call + cache rules as text generation.

  - User flow:

    1. User clicks [Regenerate Background] (inline control near preview background).
    2. UI shows a transient candidate area: spinner + “Generating image…”.
    3. Client issues exactly one image-generation request (payload: { prompt, updateId, imageOptions }) or re-uses a cached image if present for the same prompt/options.
    4. On success show candidate image with [Accept] and [Try Again] buttons.
    5. Accept attaches the selected image asset to the preview (stored under `previewStore.userOverrides[updateId].assets`) and closes the overlay. Try Again triggers a new single image request.
    6. All results are cached and re-used; no automatic repeated calls.

  - Concrete actionables:

    - Extend `client/src/stores/previewStore.js` with `imageCache: Map<imageKey, {url, meta}>` and `userOverrides[updateId].assets`.
    - Add helper `generateImage(prompt, options, signal)` → dedupe + cache; return cached result when possible.
    - Create `client/src/components/ImageControl.svelte` (Regenerate/Accept/Try Again UI) and integrate it in `PreviewWindow.svelte`.
    - Use AbortController for cancellable image requests.

  - Acceptance: Regenerate issues one outbound image request; returned image displays as candidate; Accept attaches asset to preview and is cached; Try Again issues a new request; UI remains responsive.
  - Edge cases: large image sizes (server resize), rapid clicks (disable control while pending + abort), offline/failure (persistent error + retry), multiple updateIds (assets attached to specific updateId).
  - Tests: unit test for `imageCache` dedupe (Vitest), component test for `ImageControl` simulate regenerate→accept, optional headless integration with `USE_REAL_AI=false`.
  - Est.: 2–4h

- 1F — Client-side HTML snapshot (downloadable single-page preview):

  - Goal: provide a very low-cost export path that produces a self-contained HTML snapshot of the current one-page preview for quick verification and sharing without invoking server-side export or additional AI calls.

  - User flow:

    1. User finalizes preview (after 1C/1D/1E).
    2. User clicks `Download HTML` control.
    3. Client builds a single HTML file (inline CSS + embed images as data-URIs where possible) and triggers a browser download named `aetherpress-preview-<updateId>.html`.
    4. User opens the file locally to view the one-page preview.

  - Concrete actionables:

    - Add a `Download HTML` button in `client/src/components/PreviewWindow.svelte`.
    - Add `client/src/utils/htmlSnapshot.js` with `buildSnapshotHtml(finalPreview)` and `downloadBlob()` helpers.
    - Use `previewStore` for `finalPreview` and `imageCache`; do not call AI services.
    - Attempt to embed images as data-URIs where CORS allows; fallback to external URLs with a user warning in the snapshot.

  - Acceptance: clicking Download HTML results in a single, named `.html` file that renders the preview offline (images embedded where possible); no model calls occur; user warned if images remain external.
  - Edge cases: CORS blocking of image embedding (fallback to external URLs + warning), large embedded assets (warn user if >10MB), fonts and remote CSS (inline critical CSS, leave remote fonts as optional enhancement).
  - Tests: unit test for `buildSnapshotHtml` (contains `updateId` and preview content), manual smoke: generate preview → download snapshot → open in browser.
  - Est.: 1–2h (basic), +1h for robust asset embedding and toggles.

- Cost control / caching requirement (hard):
  - The generation service must be invoked exactly once per user generation intent during 1B. Store the returned text in a short-lived cache keyed by an `updateId` or prompt hash. Any subsequent UI transitions, replays, retries, or confirm-to-preview steps should reuse the cached result. Implement dedupe logic and/or AbortController so accidental duplicate requests are prevented.

1. Hide / make dev indicator toggleable

- What: Remove or hide the bottom "DEV UI STATE: idle" for normal users. Make it visible only when a dev flag is enabled (`VITE_DEV_UI=true`) or move it into a collapsible dev overlay.
- Files: footer or layout component where the text is rendered (search for `DEV UI STATE`), add env toggle.
- Acceptance: indicator not shown by default; no layout shift; toggleable in dev.
- Est.: 0.5h

2. Preview: show placeholder immediately, replace or clear on result

- What: Implement a `PreviewSkeleton` (layout skeleton + optional shimmer) and a centered spinner/message. On generate: show skeleton+spinner immediately. On success: crossfade to content. On failure: clear content and show an error panel with a prominent "Try again" button.
- Files: `client/src/components/Preview.svelte` (or equivalent), add `PreviewSkeleton.svelte`, `Spinner.svelte`, update `previewStore` or caller logic to expose `isPreviewing`, `previewError`.
- Acceptance: skeleton displays within 50ms of action; content fades in smoothly (150–250ms); errors replace skeleton and show retry.
- Est.: 2–4h

\*\*\* End Patch

3. Button states: immediate visual feedback

- What: Show spinner+disabled visual on primary actions (Generate). Ensure visual contrast for disabled state and quick state change (<100ms perceived).
- Files: button component(s) used for generation actions.
- Acceptance: clicking Generate immediately shows spinner and disabled style; prevents duplicate requests.
- Est.: 0.5–1h

4. Race protection: apply update tokens/version ids

- What: Add a lightweight `updateId` (monotonic id or UUID) attached to each generation request. Apply results only if `updateId` matches latest request to avoid stale overwrites.
- Files: `client/src/stores/previewStore.js` (or request caller); `uiStateStore` adjustments as needed.
- Acceptance: rapid repeated generates only show final result; no flicker from older responses.
- Est.: 1–3h

Short-term (same day, moderate effort)

5. Reduce debounce and enforce minimal skeleton time

- What: Set auto-preview debounce to 200ms (configurable). Enforce a minimal skeleton visibility (e.g., 300ms) to avoid perceptual flashing for fast responses.
- Files: `previewStore`, config/constants.
- Acceptance: debounce 200ms default; skeleton visible ≥300ms when shown.
- Est.: 1–2h

6. Error UX: persistent, accessible error state + retry

- What: Ensure error messages persist until user dismisses or retries. Move keyboard focus to the error panel when it appears for accessibility and rapid recovery.
- Files: `Preview.svelte`, `StatusDisplay.svelte` or shared `uiStateStore`.
- Acceptance: errors persist and receive focus; Try Again retriggers flow and re-displays skeleton.
- Est.: 1–2h

Follow-up (optional before handoff)

7. Smooth transitions and accessible live regions

- What: Crossfade skeleton ↔ content (150–250ms) and apply `aria-live` rules: loading polite, errors assertive. Add `role="status"` where appropriate.
- Est.: 1–2h

8. Minimal tests (unit + integration smoke)

- What: Add small Vitest tests to verify preview flows (loading→success, loading→error→retry) and a test for race protection (updateId). Keep tests small and fast.
- Est.: 0.5–1 day

---

## Quick implementation checklist (for PRs)

- [x] Hide/dev-toggle `DEV UI STATE` indicator (dev-only)
- [x] Add `PreviewSkeleton.svelte` and `Spinner.svelte`
- [x] Update `Preview.svelte` to show skeleton/spinner on generate and error panel on failure (implemented in `PreviewWindow.svelte`)
- [x] Update Generate button to show spinner/disabled state immediately
- [x] Add `updateId` protection in preview request flow
- [x] Reduce debounce to 200ms and enforce skeleton min-time (300ms)
- [ ] Add basic accessibility (aria-live, focus on error)
- [ ] Add 2–3 unit/integration tests for the flow

---

## Verification (manual smoke)

1. Start client (dev). Click Generate once — skeleton+spinner appear immediately; content replaces skeleton on success with smooth fade.
2. Click Generate repeatedly — only final content shows after operations complete; no older content overwrites later content.
3. Force a failure (simulate server error) — skeleton/spinner replaced by error panel; focus lands in error panel; Try Again re-attempts and shows skeleton.

---

## Implementation log

Document PRs/changes here as they are merged:

| Date       | Change                                                                                                                                                                                                                                                                                                                                           | PR/Notes                                                                                                                                                          |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-09-05 | Implemented rapid UI responsiveness fixes: hid dev indicator behind `VITE_DEV_UI`, added `Spinner.svelte` and `PreviewSkeleton.svelte`, updated `PreviewWindow.svelte` to show skeleton+spinner, added updateId race protection, reduced debounce to 200ms, enforced 300ms minimal skeleton visibility, updated Generate button to show spinner. | Changes in `client/src/components/StatusDisplay.svelte`, `PreviewWindow.svelte`, `PromptInput.svelte`, new components `Spinner.svelte`, `PreviewSkeleton.svelte`. |

Verification notes:

- `DEV UI STATE` hidden: manual verification confirmed by user.
- Component + store changes: unit tests (Vitest) pass; automated headless verification attempted but could not detect the `data-testid` preview element (logs show preview API 200 and preview HTML returned). A DOM attribute marker (`data-preview-updated`) is present indicating preview flow executed; further manual visual verification recommended (open app in browser and load demo). See details in implementation log above.

---

If you want, I can implement the Immediate items now (hide dev indicator, add skeleton/spinner, wire error panel, and add update token protection). Confirm and I will proceed to make the code edits and run tests.
