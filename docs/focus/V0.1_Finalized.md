## Background job queue decision (V0.1)

Decision: For fastest safe V0.1 delivery we will implement Option 3 — a SQLite-backed job table.
Rationale:

- Durable: job records persist across server restarts and are queryable.
- Low friction: reuses existing SQLite DB and `crud` helpers already present in the repo.
- Simple to implement: a small `jobs` table + claim/claim-update pattern is reliable for single-node workloads.
- Easy migration path: later swap to BullMQ by replacing the `enqueueJob` and worker loop with BullMQ Queue/Worker while keeping the same `processExportJob(job)` processing function.

What we'll implement now (V0.1 scope):

1. Add a `jobs` table schema to the server DB initialization (id, payload JSON, state, progress, file_path, error, created_at, updated_at, locked_by, locked_at).
2. Implement `server/jobs.js` with `enqueueJob`, `getJob`, `claimNextJob`, `updateJobProgress`, `finalizeJob`, `failJob` helpers.
3. Update `POST /api/export/job` to call `enqueueJob(payload)` and return a jobId immediately (keep in-memory fallback if DB unavailable).
4. Add `server/worker-sqlite.js` — a small polling worker that claims and processes jobs, writes PDFs to `server/samples/exports/` with atomic temp-write + rename, and updates job progress.
5. Add a small recovery pass: jobs in `processing` older than X minutes will be returned to `queued` for retry.

Minimal "swap-to-BullMQ" path later:

- Keep a single enqueue abstraction `enqueueExportJob(payload)` used by the HTTP endpoint.
- Keep the export processing function `processExportJob(job)` standalone.
- Replace the enqueue impl to `Queue.add(...)` and run a Bull Worker that calls `processExportJob`.

Next step: I will commit the documentation change and push it to `origin/feat/image-generation-pipeline` so the decision is recorded. Further implementation can be picked up in a follow-up session.

# V0.1 Finalization Plan

_Generated: August 23, 2025 - Focus: Summer Poems eBook Demo_

This document outlines the minimal path to complete V0.1, specifically focused on delivering the demo goal:

> Produce an A4 eBook of public-domain summer poems — one poem per page with a poem-describing decorative background image

## Core Requirements Analysis

1. **Content Generation Pipeline**

   - [x] Prompt endpoint (2h remaining)
     - [x] Basic endpoint implemented
     - [ ] Add summer-specific prompt enhancement
     - [ ] Add error handling for AI service failures

2. **Image Generation Integration**

   - [~] Background Image Pipeline (implemented: offline stub, 1h)
     - [x] Add poem-to-image prompt formatting (basic: title/author injection)
     - [x] Implement offline SVG stub generator (server/imageGenerator.js)
   - [x] Implement optional SVG->PNG rasterization when `sharp` is available (server/imageGenerator.js)
   - [x] Add Gemini integration placeholder (generateWithGemini) — gated by env var
   - [ ] Integrate Gemini image generation (deferred)
   - [ ] Implement image quality validation (deferred)
   - [x] Add fallback handling using stub generator

3. **PDF Generation & Quality**

   - [x] A4 PDF Export Pipeline (verified)
     - [x] Configure Puppeteer for A4 format
     - [x] Add page-per-poem layout template
     - [x] Implement image-text composition (SVG backgrounds supported)
     - [ ] Add basic quality checks (DPI, fonts)
   - [x] Add lightweight PDF validation (page size heuristic + font marker check) — non-fatal warning mode (server/pdfGenerator.js)

4. **Minimal UI Requirements**

   - [x] Basic Prompt Interface (1h remaining)
     - [x] Prompt input implemented
     - [ ] Add summer poems specific guidance
   - [x] Preview Implementation (0.5h remaining)
     - [x] Basic preview working
   - [x] Add image placement preview (client PreviewWindow overlays server image)
   - [x] Export Controls (0.5h remaining)
     - [x] Export button implemented
   - [x] Add export progress indicator (client ExportButton shows staged progress)

5. **Critical Testing**

   - [ ] E2E Demo Flow (2h)
     - [ ] Test full summer poem generation
     - [ ] Verify image generation
     - [ ] Validate PDF output quality
   - [x] E2E Demo Flow (smoke verified: 2025-08-23)

     - [x] Test full summer poem generation (in-process smoke)
     - [x] Verify image generation (offline SVG stub used)
     - [x] Validate PDF output quality (artifact written)

     Artifact: /tmp/aetherpress-tNgjvp/automated_export_test_inproc.pdf (size: 15704 bytes)

   - [ ] Error Handling (2h)
     - [ ] Test AI service failures
     - [ ] Test image generation failures
     - [ ] Test PDF export errors

## Priority Tasks (In Order)

1. **Image Generation Integration** (4h)

   - Highest priority as it's completely missing
   - Required for demo goal completion

2. **PDF Quality Enhancement** (3h)

   - Critical for demo output quality
   - Focus on A4 formatting and image placement

3. **E2E Testing & Error Handling** (4h)

   - Essential for demo reliability
   - Focus on happy path + critical error cases

4. **UI Refinements** (2h)
   - Polish existing implementation
   - Add minimal required features

## Total Time Estimate: 13 hours

### Success Criteria

1. Generate summer-themed poem with appropriate prompt enhancement
2. Generate matching decorative background image
3. Compose poem and image in A4 PDF format
4. Export high-quality multi-page eBook
5. Handle basic error cases gracefully

### Not Required for V0.1

1. Advanced error handling
2. Performance optimization
3. Full type coverage
4. Comprehensive documentation
5. Production deployment guide

## Next Actions (In Priority Order)

1. Start image generation integration
2. Enhance PDF generation for A4 with images

- [x] Add background export job endpoints (`POST /api/export/job`, `GET /api/export/job/:id`) for progress polling

3. Implement critical path error handling
4. Add minimal UI enhancements
5. Run and verify E2E tests

_Note: This plan focuses only on components directly required for the summer poems eBook demo, deferring all non-essential features to post-V0.1._
