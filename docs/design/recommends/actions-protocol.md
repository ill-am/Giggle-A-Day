## Actions handling: sampleService → genieService (summary)

## Purpose

This short summary defines the two-step runtime contract for producers and the orchestrator:

- `sampleService` (producer) will emit an `actions` object alongside the canonical `out_envelope`. Initially the object will be empty (`{}`) to explicitly indicate "no special instructions".
- `genieService` (orchestrator) will inspect `actions`. If empty/absent/invalid it MUST run the existing default pipeline (no-op semantics). If non-empty, it validates and dispatches whitelisted actions.

## Design goals

- Backwards-compatible: default behaviour is unchanged when `actions` is empty or missing.
- Explicitness: producers include the `actions` key (even if empty) to make intent visible in persisted results and logs.
- Safe opt-in: non-empty `actions` are opt-in and run only after validation, authorization and sanitization.
- Gradual rollout: start with a minimal, safe action set; expand after validation + CI checks.

## Producer (sampleService) responsibilities

- Always include an `actions` key in the returned packet: e.g. `{ out_envelope: {...}, actions: {} }`.
- Initially `actions` should be empty. Later producers may populate it with whitelisted instructions.
- Keep producers pure: do not perform side-effects for actions; only declare them.

## Orchestrator (genieService) responsibilities

1. Read `actions` from incoming packet.
2. If `!actions || isShallowEmpty(actions)` → treat as explicit default: run the current pipeline unchanged.
3. If non-empty:
   - Validate shape against a whitelist/schema (per `actionsVersion`).
   - Authorize caller for sensitive keys (webhooks, storage, external writes).
   - Sanitize any external inputs (URLs, filenames, paths).
   - Dispatch handlers for supported actions in a deterministic order (persist → images → export → webhooks), recording a job/action intent for audit/retry.
4. On invalid/ambiguous/unauthorized instructions: log the failure, optionally emit a structured warning metric, and fall back to default behaviour.

## Behavioural guarantees

- Empty `actions` means explicit "do nothing special"; genieService will run default behaviour.
- Unknown or unsafe actions are ignored (logged) and default behaviour is used.
- Action execution should be idempotent where feasible and tracked by job/request id to support retries.

## Minimal safe action set (initial rollout)

- `persist` — persist prompt/result to DB (non-destructive)
- `export` — produce a PDF (validate flag optional)

## Future actions (behind hardening)

- `images` (generate/save images), `webhooks`, `storage` (S3/GCS writes) — require extra validation and auth.

## Operational notes

- Add `actionsVersion` to `actions` for schema evolution (e.g. `"v1"`).
- `genieService` should emit structured logs/metrics for actions.received, actions.validated, actions.dispatched, actions.failed.
- Add a CI AJV schema check for producer outputs so PRs adding nonconforming actions are rejected.

## Rollout plan (3 steps)

1. Doc + producer change: update `sampleService` to include `actions: {}` in its response (no side-effects). Persist this change and update README/docs.
2. Orchestrator safe path: add a light validator in `genieService` that recognizes `actions`, treats empty as default, and supports the minimal `persist` + `export` handlers behind a feature flag.
3. CI/schema + expand: add AJV schema, update tests, and progressively enable support for images/webhooks after hardening.

## Next steps (recommended)

- Create JSON Schema for `actions` v1 and add to `docs/schema/` (AJV-ready).
- Implement lightweight `genieService` validator/dispatcher behind a feature flag.
- Add audit logs for action intents (store in job table) to support retries.

## Authors

Generated by engineering discussion (2025-11-06).
