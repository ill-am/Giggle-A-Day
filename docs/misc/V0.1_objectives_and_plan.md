## V0.1 — Objectives and Implementation Plan

V0.1_objectives_and_plan -- Tue, 2nd Sep 2025

Purpose

- Capture the agreed V0.1 product objective and clear acceptance criteria for the frontend-driven export/demo flows.
- Surface a prioritized, non-technical checklist of pending implementation and automated validation tasks so the team can implement them later.

Background / Goal

- Demo goal (from README): produce an A4 eBook of public-domain summer poems — one poem per page with a poem-describing decorative background image.
- The frontend should drive the entire flow: compose content, preview, and export a high-quality A4 PDF without manual CLI interaction.

Acceptance criteria (how we know V0.1 is done)

1. Frontend UI: a user can load or create a poem (title + body + optional background) and click Export → browser downloads a PDF named `AetherPress-Export-<timestamp>.pdf`.
2. PDF output: contains one poem per A4 page, decorative backgrounds applied, readable typography, and page breaks between poems.
3. Preview: the app provides an in-browser preview that reflects the exported PDF (WYSIWYG / close match).
4. Security/Dev UX: when running in Codespaces, the Vite dev proxy injects the dev-only header so the browser can call the backend without manual header fiddling; public ports may be opened once but endpoints are protected by `DEV_AUTH_TOKEN`.
5. Automated validation: a reproducible smoke/e2e test exists that exercises preview→export and verifies the backend returns a PDF and (optionally) saves the artifact.

High-level constraints

- No secrets committed to git. Use Codespaces secrets or ignored `.env` for local dev tokens.
- Exports rely on Puppeteer/Chromium being available to the server; client should show clear diagnostics if service is not ready.

Prioritized implementation backlog (non-sequential)

Must-have (short-term)

- A. One-click demo loader: a UI button that populates the prompt/editor with a valid V0.1 demo payload. (Effort: very small)
- B. Export from UI: ensure `/export` path returns a downloadable PDF and the client triggers a download blob. (Effort: small)
- C. Client error surface: visible toasts or an error panel that shows API failures (401/502/422) instead of relying on DevTools. (Effort: small)
- D. Treat 401 as fatal in retry logic so auth failures surface immediately. (Effort: tiny)

Nice-to-have (medium-term)

- E. In‑UI smoke test: a button that runs a preview→export sequence client-side and reports pass/fail (saves a small diagnostic on failure). (Effort: small–medium)
- F. Diagnostics page: shows `/health`, Puppeteer readiness, recent export job status, and last error. (Effort: small)
- G. Playwright/Puppeteer e2e script: headless test that starts the app, runs the UI flow, and stores artifacts (PDF + screenshots). (Effort: medium)

Long-term / CI (high value)

- H. CI smoke test: GitHub Action that runs headless export on push/PR and uploads artifacts for failures. (Effort: medium)
- I. Observability: Sentry or lightweight logging to capture client exceptions and network failures. (Effort: small)

Automated validation plan (minimal viable)

1. Add a Playwright or Puppeteer script that:
   - Loads the frontend (Vite URL) or static preview that proxies to server
   - Clicks the demo loader
   - Clicks Export
   - Verifies the server responds with `Content-Type: application/pdf` and saves the response as an artifact (`tmp-smoke-export.pdf`).
2. Provide an npm script `npm run smoke:e2e` that runs the test locally and returns non-zero on failure.
3. Later wire the same script into a GitHub Action for PR validation.

### Automation status (verified)

- Playwright was added as a `devDependency` in `client/package.json` and Playwright browsers are installed during devcontainer setup via `npx playwright install --with-deps` in `postCreateCommand` / `updateContentCommand`.
- A headless smoke script exists at `client/scripts/smoke-e2e.cjs` (the repo already contains a fallback HTTP-only path). The `client` package exposes `smoke:e2e` and a local run produced `tmp-smoke-export-*.pdf` in `client/test-artifacts/` — the headless smoke flow is functionally verified in this environment.
- Remaining: in‑UI smoke button (E) and CI wiring (H).

Recent verified runtime changes (server-side)

- Dev debug route: `POST /debug/export-html` (guarded by `DEV_AUTH_TOKEN`) was added so the rewritten HTML used for export can be inspected during development.
- SVG rasterization verified: when `EXPORT_RASTERIZE_SVG=1` the server rewrite step converts page/background SVGs into PNG data-URIs prior to Puppeteer render; the rewritten HTML artifact can be saved to `server/tmp-exports/rewritten.html` for inspection.
- PDF evidence: exports created with the rasterization flags show image XObject resources in the produced PDF (e.g. `/ProcSet ... /ImageC`) confirming Chromium painted raster images into the PDF. The server saves artifacts to `server/tmp-exports/` during manual verification.
- Extraction helpers: small scripts were added under `server/scripts/` to inspect or attempt to extract images from PDFs. These are useful for quick checks but a robust extraction typically requires `pdfimages`/`mutool` or a PDF library that handles image XObjects.

Developer runbook (how to run locally — for later execution)

```bash
# Start backend (inside Codespace so dev secrets are available)
cd server
# ensure DEV_AUTH_TOKEN is set (Codespaces secret or server/.env)
node index.js

# Start frontend (Vite)
cd ../client
npm run dev

# Run smoke test locally (once Playwright/Puppeteer script added)
cd ../client
npm run smoke:e2e
```

Deliverables (by completion)

- Frontend UI: demo loader, preview, export button, in-place error toasts.
- Tests: Playwright/Puppeteer e2e script and `npm run smoke:e2e` script.
- CI: optional GitHub Action to run smoke test on push/PR.
- Docs: this planning file plus a short `docs/DEMO_README.md` that explains the single-click demo and smoke test usage.

Next actions (pick one)

- 1. Implement the frontend UI helpers first (A, B, C, D) so you can test manually with one click.
- 2. Add the in‑UI smoke test (E) and Playwright script (G) so you can run a single button/command to validate everything.
- 3. Implement CI smoke on the main branch (H) after 1–2 are in place.

Notes

- This document intentionally separates product acceptance (what the demo should produce) from engineering tasks (how to get there). Pick which item you want implemented next and I will create the necessary code, tests, and small README entries.

Status: pending implementation — this document captures the agreed goals and the prioritized plan.

---

## Tomorrow sprint (one-day push)

Objective

- Complete the minimal V0.1 prototype so the frontend can produce a demonstrable A4 PDF export from the UI and a reproducible smoke/e2e validation exists.

Top priorities (must complete today)

1. Implement A (One-click demo loader) — 30–60 minutes

   - Deliverable: UI button that populates the editor with V0.1 demo content.
   - Acceptance: Demo content loads with one click and fields are valid for export.

2. Implement B (Export from UI) — 60–120 minutes

   - Deliverable: Export button triggers POST /export and initiates a browser download of the returned PDF.
   - Acceptance: Downloaded PDF opens and contains the demo content formatted as A4 pages.

3. Implement C & D (Toasts + stop retry-on-401) — 30–60 minutes
   - Deliverable: Visible error toasts for API failures; `fetchWithRetry` treats 401 as fatal and surfaces error to UI.
   - Acceptance: Auth failures and backend errors result in clear UI messages (no silent retries).

Secondary priorities (if time allows) 4. Implement E (In‑UI smoke test) — 1–2 hours

- Deliverable: Button that runs preview→export and reports pass/fail in the UI and stores a small diagnostic JSON on failure.

5. Prepare G (Playwright/Puppeteer e2e script) — 2–4 hours
   - Deliverable: A basic headless script that simulates the UI flow and saves a PDF artifact when successful.

Risks and mitigations

- Puppeteer not available in Codespace: fallback is to run a lighter smoke test that verifies headers and response status without rendering PDF; escalate to provide a Chromium-enabled image if needed.
- Network/tunnel pf-signin interruptions: make 5173 public once and rely on `DEV_AUTH_TOKEN` to protect endpoints.

Schedule & owners

- Sprint lead: (you) — final acceptance and demo. Confirm when ready to review.
- Implementation: I'll implement A–D today and notify when complete; if you prefer a different owner, note it here.

Communication

- Status updates pushed to this branch as incremental commits. File `docs/V0.1_objectives_and_plan.md` will record the day's progress and any blockers.

Ready-to-run checklist for review

- After implementation, perform these frontend-only checks in the browser:
  - Load the app (Vite URL) and click "Load V0.1 demo".
  - Click Export and ensure the PDF downloads and opens.
  - If Export fails, the UI shows a clear toast with the error and a downloadable diagnostic JSON.

## What's next (proposed)

ASAP status — end of day check

- A (One-click demo loader): Done — client `PromptInput.svelte` includes a "Load V0.1 demo" button that populates the editor and triggers preview.
- B (Export from UI): Done — `exportToPdf` exists and the UI triggers a blob download named `AetherPress-Export-<timestamp>.pdf` when export succeeds.
- C (Client error surface / toasts): Done — `uiStateStore` drives visible status messages (loading/success/error) surfaced in the UI components.
- D (Treat 401 as fatal): Done — `fetchWithRetry` default config excludes 401 from retryable statuses so auth failures surface immediately.

Runtime note (important)

- Exact runtime status: the frontend and backend code paths for A–D are implemented in the repo, but the developer runtime requires the Vite dev server process to be started with `DEV_AUTH_TOKEN` present in its environment so the dev proxy can inject the `x-dev-auth` header into proxied requests. If Vite was started without that env var the browser UI will receive 401s from the backend and appear non-functional even though the underlying services are running.

- Recommendation: add a short `client/.env.local` (ignored) with `DEV_AUTH_TOKEN=<your-token>` for local development, or restart the Vite process with `DEV_AUTH_TOKEN` exported so the proxy injects the header. I can implement a gated dev helper (safe `.env` wiring or client-only dev header) tomorrow to remove the manual restart step.

Proposed next priorities (ranked)

1. E — In‑UI smoke test (high): implement or polish the client smoke button so it reliably runs preview→export and saves a small artifact (`tmp-smoke-export.pdf`) on success or `diagnostic.json` on failure. Acceptance: button runs end-to-end in the browser and records an artifact.

2. PDF images check (urgent): verify decorative backgrounds render in exported PDFs across environments. Concrete steps:

   - Ensure essential decorative assets (SVG/PNG) are available from `server/public/` or `server/samples/images/` so headless Chromium can fetch them deterministically.
   - Confirm `EXPORT_RASTERIZE_SVG` behavior and add a small server smoke test that saves `rewritten.html` and produces a PDF to `server/tmp-exports/` for quick verification.
   - Acceptance: exported PDF contains page backgrounds for the demo export when run in the devcontainer.

3. G — Playwright/Puppeteer e2e (medium): add the headless script under `client/scripts/` (if absent) and wire `npm run smoke:e2e`. Acceptance: headless run produces a PDF artifact in `client/test-artifacts/` and exits non-zero on failure.

4. Demo README (quick): add `docs/DEMO_README.md` with start/run steps for the demo loader and smoke test. Acceptance: a new contributor can follow the README and produce the PDF or diagnostic JSON within the devcontainer.

5. F — Diagnostics page (low-medium): implement a lightweight client diagnostics view that queries `/health`, Puppeteer readiness, and recent export job status and displays concise badges + copyable diagnostic payloads.

6. H — CI smoke workflow (follow-up): once E/G are stable, add a GitHub Action that runs `npm --prefix client run smoke:e2e` on PRs and uploads artifacts on failure.

Notes

- Short-term goal: finish E and the PDF images check (2) this sprint so the demo export reliably shows decorative backgrounds in the final PDF.
- If Puppeteer/Chromium is missing in some CI or Codespace runners, fall back to a lighter smoke test that verifies response headers/status and uploads a diagnostic JSON. The Playwright script should detect and report this case explicitly.

## Current status (live tracking)

- A: One-click demo loader — Done (client demo button loads demo content into editor and triggers preview).
- B: Export from UI — Done (client exports by POSTing to `/export` and triggers browser blob download; server-side Puppeteer must be available).
- C: Client error surface (toasts) — Done (uiStateStore toasts display loading/success/error for preview/generate flows).
- D: Treat 401 as fatal in retry logic — Done (fetchWithRetry no longer retries on 401; auth errors are surfaced immediately).
- E: In-UI smoke test — Planned (not yet implemented).
- F: Diagnostics page — Planned.
- G: Playwright/Puppeteer e2e script — Partial: headless smoke script exists and was verified locally (see Automation status above).
- H/I: CI smoke test and observability — Planned.

## What's next (short actionable items)

1. Auto-preview polish:

   - Ensure generated content (from Generate) auto-triggers preview when generation completes (tie `handleSubmit` to `handlePreviewNow`).
   - Add a compact spinner icon on the Preview button instead of text for better UX.

2. In-UI smoke test (E):

   - Implement a single button that runs preview→export client-side and verifies `Content-Type: application/pdf` in the response. Save `tmp-smoke-export.pdf` on success or a small `diagnostic.json` on failure.

3. Playwright/Puppeteer e2e (G):

   - Add a script under `client/scripts/smoke-e2e.js` that runs headless, clicks demo → export, and saves the exported PDF as an artifact.
   - Add `npm run smoke:e2e` in `client/package.json` to run the script.

4. Diagnostics & readiness (F):

   - Add a lightweight diagnostics page that fetches `/health` and Puppeteer readiness endpoints and displays recent export job status.

5. CI integration (H):
   - Add a GitHub Action that runs the `smoke:e2e` script on push/PR and uploads artifacts on failure.

Roadblock notes:

- Puppeteer availability: if Chromium is not present in the Codespace, the export will fail; as a fallback the smoke test should verify headers and status rather than a full PDF render.
- Tunnel / Codespaces auth: keep using `DEV_AUTH_TOKEN` and Codespaces secrets for public testing; do not commit secrets.

If you want, I can implement items 1 and 2 next (auto-preview polish and in-UI smoke test). Indicate which to prioritize and I'll implement, test, and push changes.

## Actionables — immediate (post-lunch)

1. CI smoke workflow (H)

   - Task: Add `.github/workflows/smoke-export.yml` that starts services (or runs server in-process), runs `npm --prefix client run smoke:e2e`, and uploads `client/test-artifacts/*.pdf` or `*.json` on failure.
   - Acceptance: workflow runs on PRs, exits non-zero on smoke failures, and uploads artifacts when the test fails.
   - Estimate: 2–4 hours.

2. Demo README (B)

   - Task: Add `docs/DEMO_README.md` with quick steps to: start server, start client, run the in‑UI smoke button, and run `npm run smoke:e2e` (include expected artifact paths: `client/test-artifacts/tmp-smoke-export-*.pdf` and diagnostic JSON on failure).
   - Acceptance: a new contributor can follow the README and produce the PDF or diagnostic file within the devcontainer.
   - Estimate: 30–60 minutes.

3. Diagnostics page (F)

   - Task: Implement a lightweight `/diagnostics` client page that fetches `/health` and Puppeteer readiness endpoints and displays status + recent export job info.
   - Acceptance: diagnostics page shows clear OK/warning/error badges and a copyable diagnostic payload for failures.
   - Estimate: 2–3 hours.

4. PDF images check (urgent)
   - Task: Investigate and fix missing images in exported PDFs. Checklist:
     - Verify exported HTML uses absolute URLs or inlined images for backgrounds (background-image:url(...) must be reachable by headless Chrome).
     - Confirm Puppeteer/Puppeteer-core or system Chrome has network access and that any CSP/agent restrictions are not blocking fetches.
     - Ensure server-side preview HTML includes correct CSS (background-size, background-position) and that fonts/resources are available to the exporter.
     - If images are loaded via external CDN, consider downloading or bundling essential decorative backgrounds into `public/` so exports are deterministic.
   - Acceptance: exported PDF contains the expected decorative backgrounds and inline images for the demo export.
   - Estimate: 1–3 hours depending on whether assets must be bundled.

## Notes

- Tests documentation: FYI — each `__tests__` file currently has a companion document describing purpose and details to help reviewers. At project close we will consolidate those into a single compact testing guide; the current multiplicity exists to ease onboarding and per-test traceability.

---

Please take lunch — when you're back I will: (1) add the CI workflow (H) and upload step, or (2) create `docs/DEMO_README.md` first if you prefer. Tell me which to prioritise and I'll proceed.
